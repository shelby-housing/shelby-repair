---
format: 
  dashboard:
    scrolling: false
    orientation: rows
---

```{r lib, warning=FALSE}
fp <- get_rehab_filepath()
ld <- scales::label_dollar()

library(readxl)
library(dplyr)
library(stringr)
library(lubridate)
library(fontawesome)
# map libs
library(sf)
library(arrow)
library(leaflet)
library(htmltools)
```

```{r makeRefs}
# Define project status steps in order
case_levels <- c(
  "Queue",
  "Pending Write-Up",
  "Write-Up Underway",
  "Pending Bid",
  "Out For Bid",
  "Rebid",
  "Contract Signing",
  "Contract Approval",
  "Start Date Pending",
  "Construction Underway",
  "Complete",
  "Cancelled",
  "On Hold"
)


case_icons <- tibble(
  project_status = case_levels,
  # compatible with leaflet
  marker_label = str_replace_all(case_levels, " |-", "_"),
  # Font awesome icons to use with project status
  icon_raw = c(
    "hourglass",
    "hourglass",
    "pencil",
    "right-from-bracket",
    "right-from-bracket",
    "right-from-bracket",
    "pen-fancy",
    "clipboard-check",
    "calendar-day",
    "screwdriver-wrench",
    "house-circle-check",
    "xmark",
    "pause"
  ),
  # colors for leaflet map
  marker_color = c(
    "gray", 
    "gray",
    "pink",
    "pink",
    "purple",
    "darkred",
    "lightblue",
    "blue",
    "darkblue",
    "red",
    "green",
    "gray",
    "gray"
    )
)

# Enable font awesome on icons
case_icons <- purrr::map(case_icons$icon_raw, fa) %>% 
  unlist() %>% 
  bind_cols(case_icons) %>% 
  rename(icon = 1)

# Project statuses considered "active"
case_active <- case_levels[3:10]

# Active + Completed
case_active_done <- case_levels[3:11]

# Project statuses with active contractors
contractor_active <- case_active[5:8]

# Street endings to match queue, active, cancelled (todo: address functions)
street_ends <- str_c(
  "\\b(", 
  str_flatten(c(
    "St", "Ave", "Dr", "Rd", "Ln", "Cv", "Cir", "Way", "Pl"
  ), collapse = "|"),
  ")$")
```

```{r casesData}
# This year's cases
raw_cases <- read_excel(fp, sheet = 2) |>
  janitor::clean_names() |>
  select(-c(1:3, year_built, clearance_date, execution_date, starts_with(c("idis", "lien")))) %>% 
  mutate(
    project_status = str_to_title(project_status) %>%
      str_remove_all("(?<=On Hold).*") %>%
      factor(levels = case_levels),
    street_name = str_to_title(street_name),
    across(where(is.character), ~ str_squish(.x))
  ) |>
  arrange(bid_date, desc(project_status)) %>% 
  left_join(case_icons)

# To-do: set real date to narrow to current PY
cancelled <- read_excel(fp, sheet = 6) |> 
  janitor::clean_names() %>% 
  select(1:2) %>% 
  mutate(across(where(is.character), ~ str_squish(.x)))

queue <- read_excel(fp, sheet = 5, skip = 1) |> 
  janitor::clean_names() %>% 
  select(neighborly_id, address) %>% 
  mutate(address = str_to_title(address),
         street_number = as.numeric(str_extract(address, "^\\d+\\b")),
         address = str_remove(address, "^\\d+ "),
         zip = str_extract(address, "\\d{5}$"),
         address = str_remove(address, " \\d{5}$"),
         dir_1 = str_extract(address, "^[NSEW]\\b"),
         address = str_remove(address, "^[NSEW] "),
         street_end = str_extract(address, street_ends),
         address = str_remove(address, street_ends),
         across(where(is.character), ~ str_squish(.x))) %>% 
  rename(street_name = address) %>% 
  select(neighborly_id, street_number, street_name, everything()) %>% 
  anti_join(raw_cases) %>% 
  anti_join(cancelled)
```

```{r makeVars}
# value boxes & status table counts
c_active <- nrow(
  raw_cases %>% filter(project_status %in% case_active)
)

c_done <- nrow(
  raw_cases %>% filter(project_status == "Complete")
)

c_cancel <- nrow(cancelled)

c_queue <- nrow(queue) + nrow(
  raw_cases %>% filter(project_status == "Pending Write-Up")
)
```

```{r makeSf}
# Add shapefile (sf) data for map
sf_commish <- read_sf("../data/hsg/geom/shelby/commish/commish.shp")
parcels <- read_csv_arrow("../data/hsg/data-raw/adb/2023/PARDAT.txt",
                          as_data_frame = FALSE) %>% 
  select(PARID, street_number = ADRNO, ADRDIR, street_name = ADRSTR) %>% 
  mutate(street_name = str_to_title(street_name),
         street_number = as.double(street_number)) %>% 
  right_join(raw_cases, by = c("street_number", "street_name")) %>% 
  collect()

# narrow to active or done, create leaflet labels
parid_cases <- parcels %>% 
  filter(project_status %in% case_active_done) %>% 
  mutate(
    marker_label = factor(marker_label, levels = c(case_icons$marker_label)),
         label = paste0(
          "<b>Project:</b> ", street_name, 
          "<br><b>Status:</b> ", project_status
          ),
         label = case_when(
           project_status == "Write-Up Underway" ~ label,
           project_status %in% c("Pending Bid", "Out For Bid", "Rebid") ~ 
             paste0(label, "<br><b>Bid Date:</b> ", bid_date),
           project_status %in% 
             c("Contract Signing", "Contract Approval", "Start Date Pending") ~ 
             paste0(label, 
                    "<br><b>Contractor:</b> ", contractor, 
                    "<br><b>Bid Date:</b> ", bid_date, 
                    "<br><b>Bid Amount:</b> ", ld(bid)),
           project_status == "Construction Underway" ~ 
             paste0(label, 
                    "<br><b>Contractor:</b> ", contractor, 
                    "<br><b>Bid Date:</b> ", bid_date, 
                    "<br><b>Bid Amount:</b> ", ld(bid), 
                    "<br><b>Start Date:</b> ", start_date),
           project_status == "Complete" ~ 
             paste0(label, 
                    "<br><b>Contractor:</b> ", contractor, 
                    "<br><b>Bid Date:</b> ", bid_date, 
                    "<br><b>Start Date:</b> ", start_date, 
                    "<br><b>Completed Date:</b> ", completed_date,
                    "<br><b>Bid Amount:</b> ", ld(bid), 
                    "<br><b>Change Orders:</b> ", ld(change_order),
                    "<br><b>Total Amount:</b> ", ld(total),
                    "<br><b>Funding:</b> ", funding
                    ),
           .default = label
         )
         )

# turn it into a sf
sf_cases <- read_sf("../data/hsg/geom/shelby/parcel/parcel.shp") %>% 
  right_join(parid_cases, by = c("parcel_id" = "PARID")) %>% 
  st_centroid() 
```

## Row

::: {.valuebox icon="hourglass" color="blue"}
Queue

`{r} c_queue`
:::

::: {.valuebox icon="tools" color="yellow"}
Active projects

`{r} c_active`
:::

::: {.valuebox icon="house-check" color="green"}
Completed projects

`{r} c_done`
:::

## Row

### Column

#### Row {height=55%}

```{r tblDistricts}
#| title: County Districts
cases_district <- sf_cases %>% 
  st_join(sf_commish) %>% 
  st_drop_geometry() %>% 
  group_by(district) %>% 
  count() %>% 
  ungroup()

cases_district %>% 
  knitr::kable(
    col.names = c("District", "#"),
    align = "lr"
  )
```

```{r tblContractors}
#| title: "Contractors"
raw_cases %>% 
  filter(project_status %in% contractor_active) %>% 
  group_by(contractor) %>% 
  count() %>% 
  ungroup() %>% 
  knitr::kable(
    col.names = c("Contractor", "#")
  )
```

#### Row

```{r tblProjStatus}
#| title: Project Status Overview

# how many of each project status?
status_table <- raw_cases %>% 
  select(icon, project_status) %>% 
  summarise(
    value = n(), .by = project_status
  ) %>% 
  add_row(project_status = c("Queue", "Cancelled"),
          value = c(nrow(queue), c_cancel)) %>% 
  mutate(project_status = factor(project_status, levels = case_levels)) %>% 
  arrange(project_status) %>% 
  left_join(case_icons) %>% 
  mutate(grp = cur_group_id(), .by = icon) %>% 
  group_by(grp, icon) %>% 
  summarise(name = str_flatten(project_status, collapse = "/"),
            value = sum(value)) %>% 
  ungroup() %>% 
  select(-grp)

status_table %>% 
  knitr::kable(
    align = "llr",
    col.names = c("", "Status", "#"),
    format = "simple"
  )
```

### Column {width=65%}

#### Row {height=55%}

```{r leaflet}
awe_icons <- function(x) {
  p <- str_replace_all(x, "_", " ")
  t <- case_icons %>%
    mutate(project_status = str_replace(project_status, "-", " ")) %>% 
    filter(project_status == p)
  
  x = makeAwesomeIcon(
    text = fa(t$icon_raw),
    library = "fa",
    markerColor = t$marker_color
  )
}

awe_names <- case_active_done %>% str_replace_all(" |-", "_")

awe_list <- sapply(awe_names, awe_icons, simplify = FALSE)

class(awe_list) <- "leaflet_awesome_icon_set"

leaflet(sf_cases) %>% 
  addTiles() %>% 
  addAwesomeMarkers(
    icon = ~ awe_list[marker_label],
    label = lapply(sf_cases$label, HTML),
    group = ~ project_status
  ) %>% 
  addLayersControl(
    overlayGroups = case_active_done,
    options = layersControlOptions(collapsed = FALSE)
  )
```

#### Row

```{r tblActiveProj}
#| title: Current Active Projects
raw_cases %>% 
  filter(project_status %in% case_active) %>% 
  select(street_name, contractor, project_status, bid_date, bid) %>% 
  mutate(
    project_status = factor(project_status, levels = c(case_active)),
    bid = ld(bid)
    ) %>% 
  arrange(desc(project_status)) |> 
  knitr::kable(
    col.names = c("Project", "Contractor", "Status", "Bid Date", "Amount")
      )
```
